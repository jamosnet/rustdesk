name: Build RustDesk 1.4.0 IPA (Unsigned)

on:
  workflow_dispatch: # 允许手动点击运行

jobs:
  build-ios:
    name: Build iOS
    # 修改点1：macos-13 已废弃，改为 macos-latest (通常是 macOS 14/15 ARM64)
    runs-on: macos-latest
    
    steps:
      # 1. 强制拉取 1.4.0 版本的代码
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0 
          submodules: recursive

      # 2. 配置 Rust 环境
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        
      # 3. 配置 Flutter 环境
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # 4. 安装依赖
      - name: Install Dependencies
        run: |
          brew install llvm yasm
          # 尝试升级 pip 以防止旧脚本报错
          pip3 install --upgrade pip setuptools

      # 5. 生成 Rust 桥接文件 (增加容错处理)
      - name: Generate Bridge (Rust)
        run: |
          # 如果 build.py 存在则运行，否则跳过
          if [ -f "build.py" ]; then
            python3 build.py --target ios || echo "Python build script warning (ignored)"
          fi

      # 6. 核心构建命令 (无签名模式 + 禁用部分检查)
      - name: Build IPA (No Codesign)
        run: |
          flutter clean
          flutter pub get
          # 修改点2：增加 --no-codesign，并确保 release 模式
          flutter build ios --release --no-codesign

      # 7. 打包成 Payload 结构
      - name: Package into IPA
        run: |
          mkdir Payload
          # 在新版 runner 上，路径可能会有变化，这里使用通配符查找 .app
          APP_PATH=$(find build/ios -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app file not found!"
            exit 1
          fi
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload

      # 8. 上传结果
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
