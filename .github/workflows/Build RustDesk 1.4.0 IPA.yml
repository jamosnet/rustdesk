name: Build RustDesk 1.4.0 IPA (Unsigned)

on:
  workflow_dispatch: # 允许手动点击运行

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest # 使用最新的 macOS 环境
    
    env:
      # 显式设置 LLVM 和 Clang 路径，防止旧版构建脚本找不到编译器
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"

    steps:
      # 1. 拉取代码
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. 配置 Rust (锁定旧一点的 stable 版本以增加兼容性)
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0 # 锁定一个较旧的稳定版，防止新版语法检查太严

      # 3. 配置 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # 4. 安装依赖 (关键修改：修复 Python 和 LLVM 路径)
      - name: Install Dependencies
        run: |
          brew install llvm yasm
          # 将 LLVM 强制加入 PATH
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          
          # 修复报错：加上 --break-system-packages 强制安装
          pip3 install --upgrade pip setuptools --break-system-packages
          
          # 如果 build.py 需要 requests 等库，也顺便装上
          pip3 install requests --break-system-packages || true

      # 5. 生成 Rust 桥接文件
      - name: Generate Bridge (Rust)
        run: |
          # 检查是否有 python 构建脚本
          if [ -f "build.py" ]; then
            echo "Found build.py, running..."
            # 同样加上环境变量以防万一
            export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
            python3 build.py --target ios || echo "Build.py failed but trying to continue..."
          else
            echo "No build.py found, skipping."
          fi

      # 6. 核心构建命令 (无签名)
      - name: Build IPA (No Codesign)
        run: |
          flutter clean
          flutter pub get
          # 增加 release 模式和无签名参数
          flutter build ios --release --no-codesign

      # 7. 打包
      - name: Package into IPA
        run: |
          mkdir Payload
          # 查找构建出的 .app 文件
          APP_PATH=$(find build/ios -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app file not found!"
            exit 1
          fi
          echo "Found app at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload

      # 8. 上传
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
