name: Build RustDesk 1.4.0 IPA (Unsigned)

on:
  workflow_dispatch: # 允许手动点击运行

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    env:
      # 显式设置环境变量
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"

    steps:
      # 1. 拉取代码
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. 配置 Rust (锁定旧版本)
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0

      # 3. 配置 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # 4. 安装依赖 (修复 Python/LLVM 环境)
      - name: Install Dependencies
        run: |
          brew install llvm yasm
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          pip3 install --upgrade pip setuptools --break-system-packages
          pip3 install requests --break-system-packages || true

      # 5. 生成 Rust 桥接文件 (这一步必须在根目录跑)
      - name: Generate Bridge (Rust)
        run: |
          if [ -f "build.py" ]; then
            export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
            # 运行 build.py 生成必要的库文件
            python3 build.py --target ios || echo "Warning: build.py issue (ignored)"
          fi

      # 6. 核心构建命令 (关键修改：增加 working-directory)
      - name: Build IPA (No Codesign)
        working-directory: ./flutter   # <--- 关键修复：进入 flutter 子目录
        run: |
          flutter clean
          flutter pub get
          # 增加 --no-codesign 
          flutter build ios --release --no-codesign

      # 7. 打包 (路径也要对应修改)
      - name: Package into IPA
        run: |
          mkdir Payload
          # 因为我们在根目录找，但构建是在 flutter 目录下生成的
          # 正确的路径通常是 build/ios/archive/Runner.xcarchive... 或者 flutter/build/...
          # 我们直接全盘搜索 Runner.app 比较稳妥
          APP_PATH=$(find . -name "Runner.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: Runner.app not found! Build likely failed."
            exit 1
          fi
          
          echo "Packaging app from: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload

      # 8. 上传
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
