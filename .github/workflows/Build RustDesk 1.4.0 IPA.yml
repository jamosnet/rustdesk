name: Build RustDesk 1.4.0 IPA (Ultimate Fix)

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    env:
      # æ˜¾å¼æŒ‡å®šç¼–è¯‘å™¨è·¯å¾„
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"
      # å¼ºåˆ¶ Flutter èµ°é•œåƒ
      FLUTTER_STORAGE_BASE_URL: https://storage.googleapis.com

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. å‡†å¤‡ Rust 1.81 (è§£å†³ä¾èµ–åº“è¿‡æ–°é—®é¢˜)
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt

      # 3. å‡†å¤‡ Flutter 3.13.9 (å…¼å®¹ä»£ç çš„ UI ç‰ˆæœ¬)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.9'
          channel: 'stable'
          cache: true

      # 4. å®‰è£…ç³»ç»Ÿçº§ä¾èµ– + PyYAML
      - name: Install System Dependencies
        run: |
          brew install llvm yasm
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          # å®‰è£… PyYAMLï¼Œå®ƒæ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒå·¥å…·
          pip3 install pyyaml --break-system-packages

      # 5. ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ PyYAML é‡æ„ pubspec.yaml
      # å½»åº•è§£å†³ "Error on line 121" å’Œ "Duplicate mapping key"
      - name: Patch Dependencies (Safe Mode)
        run: |
          python3 -c "
          import yaml
          import os

          path = 'flutter/pubspec.yaml'
          print(f'ğŸ”§ Reading {path}...')
          
          with open(path, 'r') as f:
              # safe_load ä¼šå¿½ç•¥æ³¨é‡Šä½†ä¿è¯ç»“æ„æ­£ç¡®ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬è¦çš„
              config = yaml.safe_load(f)

          # ç¡®ä¿ overrides å­—å…¸å­˜åœ¨
          if 'dependency_overrides' not in config:
              config['dependency_overrides'] = {}

          # å¼ºåˆ¶é”å®š extended_text ä¸ºæ—§ç‰ˆæœ¬ (Dart 3.0+ å…¼å®¹ç‰ˆ)
          # è¿™è§£å†³äº† 'version solving failed' é—®é¢˜
          config['dependency_overrides']['extended_text'] = '10.1.0'
          
          print('âœ… Locked extended_text to 10.1.0')

          # å°†å®Œå…¨åˆæ³•çš„ YAML å†™å›æ–‡ä»¶
          with open(path, 'w') as f:
              yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
          print('âœ… pubspec.yaml rewritten successfully')
          "

      # 6. ä¼ªé€ ç¼ºå¤±çš„ Rust æºç æ–‡ä»¶ (é˜²æ­¢ç¼–è¯‘å™¨æŠ¥é”™)
      - name: Mock Missing Source Files
        run: |
          echo 'pub const VERSION: &str = "1.4.0";' > src/version.rs
          if [ ! -f "src/inline.rs" ]; then echo '// Dummy inline' > src/inline.rs; fi
          # åˆ›å»ºç©ºçš„ bridge_generated.rs å ä½
          touch src/bridge_generated.rs

      # 7. å®‰è£…ä»£ç ç”Ÿæˆå·¥å…·
      - name: Install Bridge Codegen
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid --locked

      # 8. å®‰è£… Flutter ä¾èµ– (æ­¤æ—¶ yaml å·²è¢«å®Œç¾ä¿®å¤)
      - name: Install Flutter Dependencies
        working-directory: ./flutter
        run: |
          echo "ğŸ“¦ Running flutter pub get..."
          flutter pub get

      # 9. ç”Ÿæˆæ¡¥æ¥ä»£ç  (Bridge)
      - name: Generate Bridge
        run: |
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          flutter_rust_bridge_codegen \
            --rust-input src/flutter_ffi.rs \
            --dart-output flutter/lib/generated_bridge.dart \
            --c-output flutter/ios/Runner/bridge_generated.h \
            --class-name RustdeskImpl

      # 10. ã€é˜²æ­¢ç­¾åæŠ¥é”™ã€‘é˜‰å‰² Xcode ç­¾åè¦æ±‚
      - name: Disable Xcode Signing
        working-directory: ./flutter/ios
        run: |
          # æš´åŠ›ç§»é™¤æ‰€æœ‰ç­¾åé…ç½®
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*/PROVISIONING_PROFILE_SPECIFIER = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Runner.xcodeproj/project.pbxproj

      # 11. æœ€ç»ˆç¼–è¯‘
      - name: Build IPA
        working-directory: ./flutter
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          flutter build ios --release --no-codesign

      # 12. æ‰“åŒ…ä¸Šä¼ 
      - name: Package and Upload
        run: |
          mkdir Payload
          # æŸ¥æ‰¾ç”Ÿæˆçš„ .app
          APP_PATH=$(find flutter/build/ios -name "Runner.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
             echo "âŒ Build failed, Runner.app not found"
             exit 1
          fi
          
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
