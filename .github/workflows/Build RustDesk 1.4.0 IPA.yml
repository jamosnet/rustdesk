name: Build RustDesk 1.4.0 IPA (Final V8)

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    env:
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"
      # å¼ºåˆ¶ Flutter ä½¿ç”¨æ—§ç‰ˆå…¼å®¹æ¨¡å¼
      FLUTTER_STORAGE_BASE_URL: https://storage.googleapis.com

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. Setup Rust (1.81.0 + rustfmt)
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt

      # 3. Setup Flutter (3.13.9 - é€‚é… Dart 3.1)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.9'
          channel: 'stable'
          cache: true

      # 4. å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install System Dependencies
        run: |
          brew install llvm yasm
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          pip3 install --upgrade pip setuptools --break-system-packages

      # 5. æ‰‹åŠ¨åˆ›å»ºç¼ºå¤±çš„æºç æ–‡ä»¶
      - name: Mock Missing Source Files
        run: |
          echo "âš ï¸ Creating dummy files..."
          echo 'pub const VERSION: &str = "1.4.0";' > src/version.rs
          if [ ! -f "src/inline.rs" ]; then echo '// Dummy inline' > src/inline.rs; fi
          touch src/bridge_generated.rs

      # 6. å®‰è£…æ¡¥æ¥å·¥å…·
      - name: Install Bridge Codegen
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid --locked

      # 7. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶é™çº§ extended_text ç­‰æ’ä»¶
      # é€šè¿‡æ·»åŠ  dependency_overrides æ¥è§£å†³ç‰ˆæœ¬å†²çª
      - name: Patch Dependencies
        working-directory: ./flutter
        run: |
          echo "ğŸ”§ Patching pubspec.yaml to force compatible versions..."
          
          # åœ¨ pubspec.yaml æœ«å°¾è¿½åŠ  dependency_overrides
          # extended_text 10.1.0 æ”¯æŒ Dart 3.0+ ä½†ä¸éœ€è¦ Dart 3.5
          cat <<EOF >> pubspec.yaml

          dependency_overrides:
            extended_text: 10.1.0
            # ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œé”å®šå…¶ä»–æ£ä¹±çš„åŒ…ï¼Œæ¯”å¦‚:
            # flutter_svg: 2.0.7
          EOF
          
          echo "âœ… Patch applied. Tail of pubspec.yaml:"
          tail -n 10 pubspec.yaml

      # 8. å®‰è£… Flutter ä¾èµ– (ç°åœ¨åº”è¯¥èƒ½é€šè¿‡äº†)
      - name: Install Flutter Dependencies
        working-directory: ./flutter
        run: |
          echo "ğŸ“¦ Installing flutter dependencies..."
          flutter pub get

      # 9. ç”Ÿæˆæ¡¥æ¥æ–‡ä»¶ (Bridge)
      - name: Generate Bridge (Manual)
        run: |
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          
          # è¿è¡Œç”Ÿæˆå‘½ä»¤
          flutter_rust_bridge_codegen \
            --rust-input src/flutter_ffi.rs \
            --dart-output flutter/lib/generated_bridge.dart \
            --c-output flutter/ios/Runner/bridge_generated.h \
            --class-name RustdeskImpl
          
          if [ -f "flutter/lib/generated_bridge.dart" ]; then
            echo "âœ… Bridge generated successfully!"
          else
            echo "âŒ Bridge generation failed!"
            exit 1
          fi

      # 10. ç¼–è¯‘ IPA (æ— ç­¾å)
      - name: Build IPA (No Codesign)
        working-directory: ./flutter
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          flutter build ios --release --no-codesign

      # 11. æ‰“åŒ…
      - name: Package into IPA
        run: |
          mkdir Payload
          APP_PATH=$(find flutter/build/ios -name "Runner.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
             APP_PATH=$(find . -name "Runner.app" | head -n 1)
          fi
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: Runner.app not found! Build failed."
            exit 1
          fi
          
          echo "Packaging from: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload

      # 12. ä¸Šä¼ 
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
