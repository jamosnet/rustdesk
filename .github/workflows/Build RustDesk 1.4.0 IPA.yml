name: Build RustDesk 1.4.0 IPA (Final V56)

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    env:
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"
      FLUTTER_STORAGE_BASE_URL: https://storage.googleapis.com
      
      VCPKG_ROOT: /usr/local/share/vcpkg
      VCPKGRS_TRIPLET: arm64-ios
      VCPKGRS_DYNAMIC: 0
      
      CARGO_PROFILE_RELEASE_LTO: "false"
      RUSTFLAGS: "-C codegen-units=1"

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. Setup Rust
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt
          targets: aarch64-apple-ios

      # 3. Setup Flutter 3.19.6
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          channel: 'stable'
          cache: true

      # 4. å®‰è£…ä¾èµ–
      - name: Install System Dependencies
        run: |
          brew install llvm yasm nasm
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          # å®‰è£… toml ç”¨äºå®‰å…¨ä¿®æ”¹é…ç½®
          pip3 install pyyaml toml --break-system-packages

      # 5. å®‰è£… cargo-lipo
      - name: Install Cargo Lipo
        run: |
          cargo install cargo-lipo --locked

      # 6. å®‰è£… iOS Libs via VCPKG
      - name: Install iOS Libs via VCPKG
        run: |
          echo "âš™ï¸ Setting up vcpkg..."
          export VCPKG_ROOT="$VCPKG_INSTALLATION_ROOT"
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV
          $VCPKG_ROOT/vcpkg install opus libvpx libyuv aom --triplet arm64-ios --classic

      # 7. ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½ä¿®æ”¹ Cargo.toml (Staticlib + Version)
      - name: Patch Cargo.toml Safely
        run: |
          python3 -c "
          import toml
          
          print('ğŸ”§ Reading Cargo.toml...')
          data = toml.load('Cargo.toml')
          
          # 1. å¼ºåˆ¶å¼€å¯ staticlib (ç”¨äº iOS é“¾æ¥)
          if 'lib' not in data:
              data['lib'] = {}
          
          if 'crate-type' not in data['lib']:
              data['lib']['crate-type'] = ['cdylib'] # é»˜è®¤ä¿ç•™ cdylib
          
          if 'staticlib' not in data['lib']['crate-type']:
              print('â• Adding staticlib to crate-type')
              data['lib']['crate-type'].append('staticlib')
              
          # 2. é™çº§ flutter_rust_bridge (é…åˆæ—§ç‰ˆ codegen)
          if 'dependencies' in data and 'flutter_rust_bridge' in data['dependencies']:
              dep = data['dependencies']['flutter_rust_bridge']
              print(f'Original dependency config: {dep}')
              
              if isinstance(dep, dict):
                  # ä¿ç•™ features å’Œ optional=trueï¼Œåªæ”¹ç‰ˆæœ¬
                  dep['version'] = '=1.75.0'
              elif isinstance(dep, str):
                  data['dependencies']['flutter_rust_bridge'] = '=1.75.0'
              
              print('â¬‡ï¸ Downgraded flutter_rust_bridge to 1.75.0')
          
          with open('Cargo.toml', 'w') as f:
              toml.dump(data, f)
          print('âœ… Cargo.toml patched successfully')
          "
          
          # æ›´æ–°é”æ–‡ä»¶
          cargo update -p flutter_rust_bridge --precise 1.75.0

      # 8. ä¿®å¤ Flutter ä¾èµ–
      - name: Patch Dependencies
        run: |
          python3 -c "
          import yaml
          path = 'flutter/pubspec.yaml'
          with open(path, 'r') as f:
              config = yaml.safe_load(f)

          if 'dependency_overrides' not in config:
              config['dependency_overrides'] = {}
          
          config['dependency_overrides']['extended_text'] = '13.0.0'
          config['dependency_overrides']['flutter_launcher_icons'] = '0.12.0'
          config['dependency_overrides']['ffigen'] = '7.2.0'
          
          if 'dev_dependencies' in config and 'flutter_launcher_icons' in config['dev_dependencies']:
               config['dev_dependencies']['flutter_launcher_icons'] = '0.12.0'

          with open(path, 'w') as f:
              yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
          "

      # 9. ä¼ªé€ æºç 
      - name: Mock Missing Source Files
        run: |
          echo 'pub const VERSION: &str = "1.4.0";' > src/version.rs
          if [ ! -f "src/inline.rs" ]; then echo '// Dummy inline' > src/inline.rs; fi
          touch src/bridge_generated.rs

      # 10. å®‰è£… Codegen 1.75.0
      - name: Install Bridge Codegen (1.75.0)
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.75.0 --features uuid --locked

      # 11. Flutter Pub Get
      - name: Install Flutter Dependencies
        working-directory: ./flutter
        run: flutter pub get

      # 12. ç”Ÿæˆæ¡¥æ¥ä»£ç 
      - name: Generate Bridge
        run: |
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          flutter_rust_bridge_codegen \
            --rust-input src/flutter_ffi.rs \
            --rust-output src/bridge_generated.rs \
            --dart-output flutter/lib/generated_bridge.dart \
            --c-output flutter/ios/Runner/bridge_generated.h \
            --class-name RustdeskImpl

      # 13. Dart è¯­æ³•è¡¥ä¸
      - name: Patch Generated Bridge Code
        working-directory: ./flutter/lib
        run: |
          echo "ğŸ”§ Patching Dart code..."
          sed -i '' 's/abstract class RustdeskImpl/class RustdeskImpl/g' generated_bridge.dart
          sed -i '' 's/^class wire_/final class wire_/g' generated_bridge.dart
          sed -i '' 's/^class _/final class _/g' generated_bridge.dart
          echo "âœ… Code patched."

      # 14. ã€æ ¸å¿ƒæ­¥éª¤ã€‘ç¼–è¯‘ Rust é™æ€åº“
      - name: Build Rust Static Lib
        run: |
          echo "âš™ï¸ Configuring iOS SDK..."
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          export BINDGEN_EXTRA_CLANG_ARGS="-isysroot $SDK_PATH --target=arm64-apple-ios"
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          
          echo "ğŸš€ Compiling (Single Thread)..."
          cargo clean -p rustdesk
          # å…³é”®ï¼š--features flutter å¿…é¡»åŠ ä¸Š
          cargo build --target aarch64-apple-ios --release --jobs 1 --features flutter
          
          echo "ğŸ” Searching for library..."
          # æ™ºèƒ½æŸ¥æ‰¾ libxxx.a
          LIB_PATH=$(find target/aarch64-apple-ios/release -maxdepth 1 -name "*.a" | head -n 1)
          
          if [ -z "$LIB_PATH" ]; then
             echo "âŒ Library not found. Build failed silently?"
             ls -R target/aarch64-apple-ios/release
             exit 1
          fi
          
          echo "âœ… Found: $LIB_PATH"
          mkdir -p flutter/ios/Runner
          cp "$LIB_PATH" flutter/ios/Runner/librustdesk.a
          echo "âœ… Copied to Runner/librustdesk.a"

      # 15. ç§»é™¤ç­¾å
      - name: Disable Xcode Signing
        working-directory: ./flutter/ios
        run: |
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*/PROVISIONING_PROFILE_SPECIFIER = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Runner.xcodeproj/project.pbxproj

      # 16. æœ€ç»ˆç¼–è¯‘
      - name: Build IPA
        working-directory: ./flutter
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          flutter build ios --release --no-codesign

      # 17. æ‰“åŒ…ä¸Šä¼ 
      - name: Package and Upload
        run: |
          mkdir Payload
          APP_PATH=$(find flutter/build/ios -name "Runner.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
             echo "âŒ Build failed"
             exit 1
          fi
          cp -r "$APP_PATH" Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
