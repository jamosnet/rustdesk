name: Build RustDesk 1.4.0 IPA (Final V73)

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    env:
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      LDFLAGS: "-L/opt/homebrew/opt/llvm/lib"
      CPPFLAGS: "-I/opt/homebrew/opt/llvm/include"
      FLUTTER_STORAGE_BASE_URL: https://storage.googleapis.com
      
      VCPKG_ROOT: /usr/local/share/vcpkg
      VCPKGRS_TRIPLET: arm64-ios
      VCPKGRS_DYNAMIC: 0
      
      CARGO_PROFILE_RELEASE_LTO: "false"
      RUSTFLAGS: "-C codegen-units=1"

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Source Code (v1.4.0)
        uses: actions/checkout@v4
        with:
          ref: 1.4.0
          submodules: recursive

      # 2. Setup Rust
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt
          targets: aarch64-apple-ios

      # 3. Setup Flutter 3.19.6
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          channel: 'stable'
          cache: true

      # 4. å®‰è£…ä¾èµ–
      - name: Install System Dependencies
        run: |
          brew install llvm yasm nasm
          echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
          pip3 install pyyaml toml --break-system-packages

      # 5. å®‰è£… cargo-lipo
      - name: Install Cargo Lipo
        run: |
          cargo install cargo-lipo --locked

      # 6. å®‰è£… iOS Libs via VCPKG
      - name: Install iOS Libs via VCPKG
        run: |
          echo "âš™ï¸ Setting up vcpkg..."
          export VCPKG_ROOT="$VCPKG_INSTALLATION_ROOT"
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV
          $VCPKG_ROOT/vcpkg install opus libvpx libyuv aom --triplet arm64-ios --classic

      # 7. å¼€å¯ Staticlib
      - name: Enable Staticlib
        run: |
          python3 -c "
          import toml
          data = toml.load('Cargo.toml')
          if 'lib' not in data: data['lib'] = {}
          if 'crate-type' not in data['lib']: data['lib']['crate-type'] = ['cdylib']
          if 'staticlib' not in data['lib']['crate-type']:
              data['lib']['crate-type'].append('staticlib')
          with open('Cargo.toml', 'w') as f: toml.dump(data, f)
          "

      # 8. ä¿®å¤ Flutter ä¾èµ–
      - name: Patch Dependencies
        run: |
          python3 -c "
          import yaml
          path = 'flutter/pubspec.yaml'
          with open(path, 'r') as f: config = yaml.safe_load(f)
          if 'dependency_overrides' not in config: config['dependency_overrides'] = {}
          config['dependency_overrides']['extended_text'] = '13.0.0'
          config['dependency_overrides']['flutter_launcher_icons'] = '0.13.1'
          config['dependency_overrides']['ffigen'] = '8.0.2'
          if 'dev_dependencies' in config and 'flutter_launcher_icons' in config['dev_dependencies']:
               config['dev_dependencies']['flutter_launcher_icons'] = '0.13.1'
          with open(path, 'w') as f: yaml.dump(config, f, default_flow_style=False, allow_unicode=True)
          "

      # 9. ä¼ªé€ æºç 
      - name: Mock Missing Source Files
        run: |
          echo 'pub const VERSION: &str = "1.4.0";' > src/version.rs
          if [ ! -f "src/inline.rs" ]; then echo '// Dummy inline' > src/inline.rs; fi
          touch src/bridge_generated.rs

      # 10. å®‰è£… Codegen (1.80.1)
      - name: Install Bridge Codegen
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid --locked

      # 11. ã€æ ¸å¿ƒä¿®å¤ã€‘åˆ›å»ºå…¼å®¹ç‰ˆè‡ªç­¾åè¯ä¹¦
      # ä½¿ç”¨ Legacy ç®—æ³•å¯¼å‡º P12ï¼Œé˜²æ­¢ macOS Keychain æŠ¥é”™
      - name: Create & Trust Fake Certificate
        run: |
          echo "ğŸ” Creating Keychain..."
          security create-keychain -p "123456" build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "123456" build.keychain
          
          echo "ğŸ” Generating Certificate..."
          # ç”Ÿæˆç§é’¥å’Œè¯ä¹¦
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout selfsigned.key -out selfsigned.crt \
            -subj "/CN=iPhone Developer/C=US"
          
          # å¯¼å‡º P12 (å¼ºåˆ¶ä½¿ç”¨æ—§ç®—æ³•å…¼å®¹ macOS security)
          # æ³¨æ„ï¼šGitHub Runner çš„ OpenSSL ç‰ˆæœ¬è¾ƒæ–°ï¼Œéœ€è¦æ˜¾å¼æŒ‡å®š legacy ç®—æ³•
          openssl pkcs12 -export -in selfsigned.crt -inkey selfsigned.key \
            -out selfsigned.p12 -name "iPhone Developer" \
            -passout pass:123456 \
            -keypbe PBE-SHA1-3DES -certpbe PBE-SHA1-3DES -macalg sha1
          
          echo "ğŸ” Importing to Keychain..."
          # å¯¼å…¥å¹¶è®¾ç½®ä¿¡ä»»
          security import selfsigned.p12 -k build.keychain -P "123456" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "123456" build.keychain
          
          echo "âœ… Fake Signing Identity Created!"

      # 12. Podfile æ³¨å…¥
      - name: Inject Podfile Config
        working-directory: ./flutter/ios
        run: |
          python3 -c "
          import re
          path = 'Podfile'
          with open(path, 'r') as f: content = f.read()
          
          target_str = 'flutter_additional_ios_build_settings(target)'
          injection = \"\"\"
            flutter_additional_ios_build_settings(target)
            target.build_configurations.each do |config|
              config.build_settings['SWIFT_VERSION'] = '5.0'
              config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
              config.build_settings['ENABLE_BITCODE'] = 'NO'
              config.build_settings['ARCHS'] = 'arm64'
              config.build_settings['DT_TOOLCHAIN_DIR'] = '/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain'
              # å¯ç”¨ç­¾å (ç”¨æˆ‘ä»¬çš„å‡è¯ä¹¦)
              config.build_settings['CODE_SIGN_IDENTITY'] = 'iPhone Developer'
              config.build_settings['CODE_SIGNING_REQUIRED'] = 'YES'
              config.build_settings['CODE_SIGNING_ALLOWED'] = 'YES'
            end
          \"\"\"
          
          if re.search(r'(\s*flutter_additional_ios_build_settings\(target\))', content):
              new_content = re.sub(r'(\s*flutter_additional_ios_build_settings\(target\))', injection, content)
              with open(path, 'w') as f: f.write(new_content)
              print('âœ… Podfile patched.')
          else:
              exit(1)
          "

      # 13. Flutter Clean & Pub Get
      - name: Flutter Clean & Pub Get
        working-directory: ./flutter
        run: |
          flutter clean
          flutter pub get

      # 14. ç”Ÿæˆæ¡¥æ¥ä»£ç 
      - name: Generate Bridge
        run: |
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          flutter_rust_bridge_codegen \
            --rust-input src/flutter_ffi.rs \
            --rust-output src/bridge_generated.rs \
            --dart-output flutter/lib/generated_bridge.dart \
            --c-output flutter/ios/Runner/bridge_generated.h \
            --class-name RustdeskImpl

      # 15. Dart è¡¥ä¸
      - name: Patch Generated Bridge Code
        working-directory: ./flutter/lib
        run: |
          sed -i '' 's/abstract class RustdeskImpl/class RustdeskImpl/g' generated_bridge.dart

      # 16. ç¼–è¯‘å¹¶åˆå¹¶é™æ€åº“ (VCPKG + Rust)
      - name: Build and Merge Static Libs
        run: |
          echo "âš™ï¸ Configuring iOS SDK..."
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          export BINDGEN_EXTRA_CLANG_ARGS="-isysroot $SDK_PATH --target=arm64-apple-ios"
          export PATH="$HOME/.cargo/bin:/opt/homebrew/opt/llvm/bin:$PATH"
          
          echo "ğŸš€ Compiling Rust..."
          cargo build --target aarch64-apple-ios --release --jobs 1 -p rustdesk --lib --features flutter
          
          echo "ğŸ“¦ Merging libraries..."
          RUST_LIB=$(find target/aarch64-apple-ios/release -maxdepth 1 -name "lib*.a" | head -n 1)
          if [ -z "$RUST_LIB" ]; then echo "âŒ Rust lib not found"; exit 1; fi
          
          VCPKG_LIB_DIR="$VCPKG_INSTALLATION_ROOT/installed/arm64-ios/lib"
          mkdir -p flutter/ios/Runner
          libtool -static -o flutter/ios/Runner/librustdesk.a \
            "$RUST_LIB" \
            "$VCPKG_LIB_DIR"/libopus.a \
            "$VCPKG_LIB_DIR"/libaom.a \
            "$VCPKG_LIB_DIR"/libvpx.a \
            "$VCPKG_LIB_DIR"/libyuv.a
            
          echo "âœ… Merged library created."

      # 17. å‡†å¤‡ Xcode å·¥ç¨‹
      - name: Prepare Xcode Project
        working-directory: ./flutter
        run: flutter build ios --config-only

      # 18. ã€æ ¸å¿ƒä¿®å¤ã€‘é…ç½® Xcode å·¥ç¨‹ (Fake Signing)
      - name: Configure Xcode Project for Fake Signing
        working-directory: ./flutter/ios
        run: |
          echo "ğŸ”§ Patching Runner.xcodeproj..."
          # å…è®¸ç­¾åï¼Œå¹¶æŒ‡å®šæˆ‘ä»¬åˆ›å»ºçš„å‡è¯ä¹¦åç§°
          sed -i '' 's/CODE_SIGNING_REQUIRED = .*/CODE_SIGNING_REQUIRED = YES;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = .*/CODE_SIGNING_ALLOWED = YES;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_IDENTITY = ".*";/CODE_SIGNING_IDENTITY = "iPhone Developer";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGNING_IDENTITY\[sdk=iphoneos\*\]" = ".*";/"CODE_SIGNING_IDENTITY[sdk=iphoneos*]" = "iPhone Developer";/g' Runner.xcodeproj/project.pbxproj
          
          # æ¸…é™¤ Profile UUID (è‡ªç­¾åä¸éœ€è¦)
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*";/PROVISIONING_PROFILE_SPECIFIER = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # ç¡®ä¿å·¥å…·é“¾æ­£ç¡®
          sed -i '' 's/ENABLE_BITCODE = NO;/ENABLE_BITCODE = NO; DT_TOOLCHAIN_DIR = "\/Applications\/Xcode.app\/Contents\/Developer\/Toolchains\/XcodeDefault.xctoolchain";/g' Runner.xcodeproj/project.pbxproj

      # 19. æ‰‹åŠ¨ Archive (æ¬ºéª— Xcode æˆåŠŸ)
      - name: Build Archive via Xcodebuild
        working-directory: ./flutter/ios
        run: |
          echo "ğŸš€ Starting xcodebuild archive (With Fake Cert)..."
          
          # å»æ‰äº† || trueï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›è¿™æ¬¡æ˜¯çœŸçš„æˆåŠŸ
          xcodebuild archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath Runner.xcarchive \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            PROVISIONING_PROFILE_SPECIFIER="" \
            -allowProvisioningUpdates
            
          if [ -d "Runner.xcarchive/Products/Applications/Runner.app" ]; then
             echo "âœ… Archive success!"
          else
             echo "âŒ Archive failed."
             exit 1
          fi

      # 20. æå–å¹¶æ‰“åŒ…
      - name: Export IPA
        working-directory: ./flutter/ios
        run: |
          mkdir Payload
          cp -r Runner.xcarchive/Products/Applications/Runner.app Payload/
          zip -r RustDesk_1.4.0_Unsigned.ipa Payload
          echo "âœ… IPA created successfully."
          ls -lh RustDesk_1.4.0_Unsigned.ipa

      # 21. ä¸Šä¼ 
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-1.4.0-Unsigned-IPA
          path: flutter/ios/RustDesk_1.4.0_Unsigned.ipa
          retention-days: 3
